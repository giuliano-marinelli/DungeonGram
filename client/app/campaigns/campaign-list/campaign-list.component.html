<div class="card campaign-container own" *ngIf="auth.loggedIn">
  <h4 class="card-header">My Campaigns</h4>
  <div class="card-body" *ngIf="isLoadingOwn">
    <app-loading [condition]="isLoadingOwn"></app-loading>
  </div>
  <div class="card-body" *ngIf="!isLoadingOwn">
    <p class="card-text row">
      <span class="col">
        <span class="d-inline-block" tippy="You must be logged in to create characters" placement="right"
          [isEnabled]="!auth.loggedIn">
          <span class="d-inline-block" interactive="true" [tippy]="not_verified" placement="right"
            [isEnabled]="!auth.isVerified">
            <button type="button" class="btn btn-dark campaign-btn" (click)="openCampaign()"
              [disabled]="!auth.loggedIn || !auth.isVerified"
              attr.style="{{!auth.loggedIn ? 'pointer-events: none;' : ''}}">
              <i class="fa fa-plus"></i> New Campaign
            </button>
          </span>
        </span>
        <ng-template #not_verified>
          You need to <span class='text-warning'>verify your email</span> to enable campaign creation. <br><br>
          Go to your <a routerLink="/account">Profile</a> to do it<br>
        </ng-template>
      </span>
      <span class="col">
        <span class="input-group pull-right" style="max-width: 300px;">
          <input type="text" class="form-control campaign-input-alt" placeholder="Search..."
            [(ngModel)]="searchOwnCampaigns" (keyup)="getCampaigns(true)" />
          <button [hidden]="!searchOwnCampaigns" (click)="searchOwnCampaigns = ''; getCampaigns(true)" type="button"
            class="btn bg-transparent" style="margin-left: -40px; z-index: 100;">
            <i class="fa fa-times"></i>
          </button>
          <div class="input-group-append">
            <button class="btn campaign-btn-alt" type="button" (click)="getCampaigns(true)">
              <i class="fa fa-fw fa-search"></i>
            </button>
          </div>
        </span>
      </span>
    </p>
    <p *ngIf="ownCampaigns.length <= 0" class="card-text">
      No own campaigns found
    </p>
    <div *ngIf="ownCampaigns.length > 0" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-3 row-cols-xl-4">
      <div *ngFor="let campaign of ownCampaigns" class="col mb-4">
        <ng-container [ngTemplateOutlet]="campaignCard" [ngTemplateOutletContext]="{campaign: campaign}"></ng-container>
      </div>
    </div>
    <ngb-pagination *ngIf="countOwnCampaigns > 0" class="d-flex justify-content-end" [(page)]="pageOwnCampaigns"
      [pageSize]="pageSizeOwnCampaigns" [collectionSize]="countOwnCampaigns" (pageChange)="getCampaigns(true)">
    </ngb-pagination>
  </div>
</div>

<div class="card campaign-container">
  <h4 class="card-header">Public Campaigns</h4>
  <div class="card-body" *ngIf="isLoadingPublic">
    <app-loading [condition]="isLoadingPublic"></app-loading>
  </div>
  <div class="card-body" *ngIf="!isLoadingPublic">
    <p class="card-text text-right">
      <span class=" input-group d-inline-flex" style="max-width: 300px;">
        <input type="text" class="form-control" placeholder="Search..." [(ngModel)]="searchPublicCampaigns"
          (keyup)="getCampaigns(false)" />
        <button [hidden]="!searchPublicCampaigns" (click)="searchPublicCampaigns = ''; getCampaigns(false)"
          type="button" class="btn bg-transparent" style="margin-left: -40px; z-index: 100;">
          <i class="fa fa-times"></i>
        </button>
        <div class="input-group-append">
          <button class="btn btn-dark" type="button" (click)="getCampaigns(false)">
            <i class="fa fa-fw fa-search"></i>
          </button>
        </div>
      </span>
    </p>
    <p *ngIf="publicCampaigns.length <= 0" class="card-text">
      No public campaigns found
    </p>
    <div *ngIf="publicCampaigns.length > 0"
      class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-3 row-cols-xl-4">
      <div *ngFor="let campaign of publicCampaigns" class="col mb-4">
        <ng-container [ngTemplateOutlet]="campaignCard" [ngTemplateOutletContext]="{campaign: campaign}"></ng-container>
      </div>
    </div>
    <ngb-pagination *ngIf="countPublicCampaigns > 0" class="d-flex justify-content-end" [(page)]="pagePublicCampaigns"
      [pageSize]="pageSizePublicCampaigns" [collectionSize]="countPublicCampaigns" (pageChange)="getCampaigns(false)">
    </ngb-pagination>
  </div>
</div>

<ng-template #campaignCard let-campaign='campaign'>
  <div class="card h-100 {{getInvitation(campaign) && getInvitation(campaign).accepted == null ? 'invitation' : ''}}">
    <img [src]="campaign.banner" class="card-img-top campaign-img" alt="{{campaign.title}}"
      onerror="this.src='assets/images/campaigns/default.jpg'">
    <div class="card-body">
      <h5 class="card-title"><i *ngIf="campaign.private" tippy="This campaign is private"
          class="fa fa-user-secret">&nbsp;</i>{{campaign.title}}<br />
        <small class="text-muted">created by {{campaign.owner_info.username}}</small>
      </h5>
      <p class="card-text campaign-description mb-4"
        tippy="{{campaign.description}}{{campaign.description && getPlayers(campaign).length > 0 ? '<br />' : ''}}
        {{getPlayers(campaign).length > 0 ? '<small class=\'text-muted\'>players: ' + getPlayers(campaign).join(', ') + '</small>': ''}}"
        [isEnabled]="campaign.description || getPlayers(campaign).length > 0" placement="right">
        {{campaign.description}}
        <br />
        <small class="text-muted" *ngIf="getPlayers(campaign).length > 0">
          players: {{getPlayers(campaign).join(', ')}}
        </small>
      </p>
      <p class="card-text text-right position-absolute" style="bottom: 0.5rem; right: 0.5rem;">
        <button class="btn btn-sm btn-primary" routerLink="/game/{{campaign._id}}"
          [hidden]="auth.currentUser._id != campaign.owner && !getInvitation(campaign)?.accepted">
          <i class="fa fa-play"></i> Play
        </button>
        <button class="btn btn-sm btn-dark campaign-btn-alt ml-2" (click)="openInvite(campaign)"
          [hidden]="auth.currentUser._id != campaign.owner" tippy="Invite Players">
          <i class="fa fa-user-plus"></i>
        </button>
        <button class="btn btn-sm btn-dark campaign-btn-alt ml-2" (click)="openCampaign(campaign)"
          [hidden]="auth.currentUser._id != campaign.owner" tippy="Edit">
          <i class="fa fa-pencil"></i>
        </button>
        <button class="btn btn-sm btn-danger ml-2" (confirm)="deleteCampaign(campaign)" confirmDoubleCheck="true"
          [hidden]="auth.currentUser._id != campaign.owner" tippy="Delete">
          <i class="fa fa-trash"></i>
        </button>

        <button class="btn btn-sm btn-success ml-2" (click)="acceptInvitation(campaign)"
          *ngIf="getInvitation(campaign) && getInvitation(campaign).accepted == null">
          <i class="fa fa-check"></i> Accept
        </button>
        <button class="btn btn-sm btn-danger ml-2" (click)="deniedInvitation(campaign)"
          *ngIf="getInvitation(campaign) && getInvitation(campaign).accepted == null">
          <i class="fa fa-times"></i> Denied
        </button>
        <button class="btn btn-sm btn-danger ml-2" (confirm)="leaveInvitation(campaign)" tippy="Leave"
          *ngIf="getInvitation(campaign) && getInvitation(campaign).accepted == true">
          <i class="fa fa-sign-out"></i>
        </button>
      </p>
    </div>
  </div>
</ng-template>
